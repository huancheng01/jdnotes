# JD Notes é¡¹ç›®ç¼ºé™·ä¸ä¼˜åŒ–åˆ†ææŠ¥å‘Š

> åˆ†ææ—¥æœŸï¼š2026-01-06
> é¡¹ç›®ç‰ˆæœ¬ï¼šv1.1.0 (SQLite)

---

## ğŸ“Š é¡¹ç›®ç°çŠ¶æ¦‚è§ˆ

JD Notes æ˜¯ä¸€ä¸ªåŸºäº **Tauri v2 + React 19 + TypeScript** æ„å»ºçš„æœ¬åœ°ç¬”è®°åº”ç”¨ï¼Œå·²å®Œæˆä» IndexedDB åˆ° SQLite çš„è¿ç§»ã€‚

### âœ… å·²å®ç°åŠŸèƒ½
- å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ï¼ˆTipTap + Markdownï¼‰
- AI æ™ºèƒ½åŠ©æ‰‹ï¼ˆå³é”®èœå• + ä¾§æ å¯¹è¯ + æ–œæ å‘½ä»¤ï¼‰
- æ—¥å†è§†å›¾ï¼ˆæœˆ/å‘¨/æ—¥è§†å›¾ + çƒ­åŠ›å›¾ï¼‰
- ç¬”è®°æé†’ï¼ˆç³»ç»Ÿé€šçŸ¥ + åº”ç”¨å†…é€šçŸ¥ï¼‰
- ç¬”è®°ç®¡ç†ï¼ˆæ”¶è—ã€æ ‡ç­¾ã€åºŸçº¸ç¯“ï¼‰
- ä¸»é¢˜åˆ‡æ¢ï¼ˆæ·±è‰²/æµ…è‰²æ¨¡å¼ï¼‰
- å…¨å±€æœç´¢ï¼ˆCmd+Kï¼‰
- SQLite å­˜å‚¨ï¼ˆå¯è¿ç§»æ•°æ®åº“ä½ç½®ï¼‰

---

## ğŸš¨ ä¸¥é‡ç¼ºé™·ï¼ˆå¿…é¡»ç«‹å³ä¿®å¤ï¼‰

### 1. Dexie `useLiveQuery` ä¸ SQLite æ··ç”¨ ğŸ”´ è‡´å‘½é—®é¢˜

**é—®é¢˜æè¿°**ï¼šé¡¹ç›®å·²ä» IndexedDB è¿ç§»åˆ° SQLiteï¼Œä½†ä¸¤ä¸ªå…³é”® hook ä»åœ¨ä½¿ç”¨ Dexie çš„ `useLiveQuery`ï¼Œè¿™ä¼šå¯¼è‡´**å®æ—¶æ•°æ®æ›´æ–°åŠŸèƒ½å®Œå…¨å¤±æ•ˆ**ã€‚

**å—å½±å“æ–‡ä»¶**ï¼š

#### [`src/hooks/useCalendar.ts`](src/hooks/useCalendar.ts:2)
```typescript
import { useLiveQuery } from 'dexie-react-hooks'  // âŒ Dexie hook

// ç¬¬ 76-85 è¡Œï¼šæ—¥å†ç¬”è®°æŸ¥è¯¢
const notes = useLiveQuery(
  async () => {
    return await noteOperations.getByDateRange(
      dateRange.start,
      dateRange.end,
      dateField
    )
  },
  [dateRange.start.getTime(), dateRange.end.getTime(), dateField]
)

// ç¬¬ 88-93 è¡Œï¼šæé†’æŸ¥è¯¢
const upcomingReminders = useLiveQuery(
  async () => {
    return await noteOperations.getUpcomingReminders(30)
  },
  []
)
```

#### [`src/hooks/useChat.ts`](src/hooks/useChat.ts:2)
```typescript
import { useLiveQuery } from 'dexie-react-hooks'  // âŒ Dexie hook

// ç¬¬ 32-36 è¡Œï¼šèŠå¤©æ¶ˆæ¯æŸ¥è¯¢
const messages = useLiveQuery(
  () => (noteId ? db.chatMessages.where('noteId').equals(noteId).sortBy('timestamp') : []),
  [noteId],
  []
)
```

**ä¸¥é‡åæœ**ï¼š
1. ğŸ“… **æ—¥å†è§†å›¾**ï¼šç¬”è®°ä¿®æ”¹/åˆ é™¤åï¼Œæ—¥å†ä¸ä¼šè‡ªåŠ¨åˆ·æ–°
2. ğŸ’¬ **AI èŠå¤©**ï¼šå‘é€æ¶ˆæ¯åï¼Œæ¶ˆæ¯åˆ—è¡¨å¯èƒ½ä¸æ›´æ–°
3. ğŸ”” **æé†’åŠŸèƒ½**ï¼šæ–°æé†’å¯èƒ½ä¸ä¼šè¢«æ£€æµ‹åˆ°
4. âš¡ **è¿è¡Œæ—¶é”™è¯¯**ï¼š`useLiveQuery` ä¾èµ– IndexedDB çš„äº‹ä»¶ç³»ç»Ÿï¼Œä¸ SQLite ä¸å…¼å®¹

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

```typescript
// src/hooks/useCalendar.ts - ä¿®å¤ç‰ˆ
import { useState, useEffect, useCallback } from 'react'

export function useCalendar(): UseCalendarReturn {
  const [notes, setNotes] = useState<Note[]>([])
  const [upcomingReminders, setUpcomingReminders] = useState<Note[]>([])

  // æ‰‹åŠ¨åˆ·æ–°å‡½æ•°
  const refreshNotes = useCallback(async () => {
    const data = await noteOperations.getByDateRange(
      dateRange.start,
      dateRange.end,
      dateField
    )
    setNotes(data)
  }, [dateRange.start, dateRange.end, dateField])

  const refreshReminders = useCallback(async () => {
    const data = await noteOperations.getUpcomingReminders(30)
    setUpcomingReminders(data)
  }, [])

  // åˆå§‹åŠ è½½å’Œä¾èµ–å˜åŒ–æ—¶åˆ·æ–°
  useEffect(() => {
    refreshNotes()
  }, [refreshNotes])

  useEffect(() => {
    refreshReminders()
    // æ¯åˆ†é’Ÿæ£€æŸ¥æé†’
    const interval = setInterval(refreshReminders, 60000)
    return () => clearInterval(interval)
  }, [refreshReminders])

  // ...è¿”å› notes å’Œåˆ·æ–°å‡½æ•°
}
```

```typescript
// src/hooks/useChat.ts - ä¿®å¤ç‰ˆ
import { useState, useEffect, useCallback } from 'react'

export function useChat({ noteId, noteTitle, noteContent }: UseChatProps) {
  const [messages, setMessages] = useState<ChatMessage[]>([])

  const refreshMessages = useCallback(async () => {
    if (noteId) {
      const data = await chatOperations.getByNoteId(noteId)
      setMessages(data)
    }
  }, [noteId])

  useEffect(() => {
    refreshMessages()
  }, [refreshMessages])

  // å‘é€æ¶ˆæ¯åæ‰‹åŠ¨åˆ·æ–°
  const sendMessage = useCallback(async (content: string) => {
    // ... å‘é€é€»è¾‘
    await refreshMessages()  // åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨
  }, [refreshMessages])

  // ...
}
```

---

### 2. æœªæ¸…ç†çš„ Dexie ä¾èµ– ğŸŸ¡ é«˜ä¼˜å…ˆçº§

**é—®é¢˜æè¿°**ï¼š[`package.json`](package.json:47-48) ä¸­ä»ä¿ç•™å·²åºŸå¼ƒçš„ IndexedDB ä¾èµ–ï¼š

```json
"dexie": "^4.2.1",           // âŒ ä¸å†éœ€è¦
"dexie-react-hooks": "^4.2.0" // âŒ ä¸å†éœ€è¦
```

**å½±å“**ï¼š
- å¢åŠ çº¦ **200KB** bundle ä½“ç§¯
- ä»£ç ä¸­ import è¿™äº›åŒ…ä¸ä¼šæŠ¥é”™ï¼Œå®¹æ˜“è¯¯ç”¨
- å¼€å‘è€…å›°æƒ‘ï¼ˆå·²è¿ç§»åˆ° SQLite ä½†ä»æœ‰ Dexieï¼‰

**ä¿®å¤å‘½ä»¤**ï¼š
```bash
pnpm remove dexie dexie-react-hooks
```

---

### 3. æ•°æ®åº“å…¼å®¹å±‚è®¾è®¡é—®é¢˜ ğŸŸ¡ é«˜ä¼˜å…ˆçº§

**é—®é¢˜æè¿°**ï¼š[`src/lib/db.ts`](src/lib/db.ts:626-818) åŒ…å«çº¦ **200 è¡Œ**ç”¨äºæ¨¡æ‹Ÿ Dexie API çš„å…¼å®¹ä»£ç ï¼š

```typescript
// db.ts ç¬¬ 629-720 è¡Œ
export const db = {
  notes: {
    orderBy: (field: string) => ({
      reverse: () => ({
        filter: (fn: (note: Note) => boolean) => ({
          toArray: async (): Promise<Note[]> => {
            // æ¨¡æ‹Ÿ Dexie é“¾å¼è°ƒç”¨
          }
        })
      })
    }),
    where: (field: string) => ({
      equals: (value: number | string) => ({
        // ... å¤§é‡åµŒå¥—æ¨¡æ‹Ÿ
      })
    }),
    // ... æ›´å¤šæ¨¡æ‹Ÿæ–¹æ³•
  }
}
```

**é—®é¢˜**ï¼š
1. è¿™äº›å…¼å®¹ä»£ç ä½¿å¾— `useLiveQuery` "çœ‹èµ·æ¥èƒ½ç”¨"ï¼Œä½†å®é™…ä¸Šå¤±å»äº†å®æ—¶è®¢é˜…èƒ½åŠ›
2. ä»£ç å¤æ‚åº¦é«˜ï¼Œéš¾ä»¥ç»´æŠ¤
3. ä¸ `noteOperations` API å½¢æˆé‡å¤

**å»ºè®®**ï¼š
1. ä¿®å¤ `useCalendar.ts` å’Œ `useChat.ts` ååˆ é™¤å…¼å®¹å±‚
2. ç»Ÿä¸€ä½¿ç”¨ `noteOperations` å’Œ `chatOperations` API

---

## ğŸ”´ ä»£ç å±‚é¢çš„ç¼ºé™·

### 4. ç±»å‹å®‰å…¨é—®é¢˜ âš ï¸ é«˜ä¼˜å…ˆçº§

**é—®é¢˜æè¿°**ï¼šå¤šå¤„ä½¿ç”¨ `eslint-disable` ç¦ç”¨ç±»å‹æ£€æŸ¥ï¼Œå­˜åœ¨ç±»å‹å®‰å…¨é£é™©ã€‚

**æ¶‰åŠæ–‡ä»¶**ï¼š
- [`src/components/editor/Editor.tsx`](src/components/editor/Editor.tsx:161) - ç¬¬ 161, 203-204 è¡Œ
  ```typescript
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  onContentChange((editor.storage as any).markdown.getMarkdown())
  ```

**å»ºè®®ä¿®å¤**ï¼š
```typescript
// åˆ›å»ºç±»å‹å£°æ˜æ–‡ä»¶ src/types/tiptap.d.ts
declare module '@tiptap/core' {
  interface EditorStorage {
    markdown: {
      getMarkdown: () => string
    }
  }
}

// ç„¶åå¯ä»¥å®‰å…¨ä½¿ç”¨
onContentChange(editor.storage.markdown.getMarkdown())
```

---

### 2. åç«¯å‘½ä»¤å®ç°ä¸å®Œæ•´ âš ï¸ ä¸­ä¼˜å…ˆçº§

**é—®é¢˜æè¿°**ï¼š[`src-tauri/src/commands.rs`](src-tauri/src/commands.rs:1) ä¸­å¤§é‡å‘½ä»¤æ˜¯å ä½ç¬¦ï¼Œå®é™…æœªå®ç°åŠŸèƒ½ã€‚

**ç¤ºä¾‹**ï¼š
```rust
#[tauri::command]
pub async fn create_note(_title: String, _content: String) -> Result<i64, String> {
    // å®é™…æ“ä½œåœ¨å‰ç«¯é€šè¿‡ SQL æ’ä»¶æ‰§è¡Œ
    Ok(1)  // â† æ€»æ˜¯è¿”å› 1ï¼Œæœ‰è¯¯å¯¼æ€§
}
```

**å»ºè®®**ï¼š
1. ç§»é™¤æœªä½¿ç”¨çš„åç«¯å‘½ä»¤ï¼Œå‡å°‘æ··æ·†
2. æˆ–è€…åœ¨ Rust ç«¯å®ç°å®Œæ•´çš„æ•°æ®åº“æ“ä½œï¼Œç»Ÿä¸€æ¶æ„
3. æ·»åŠ æ¸…æ™°çš„æ³¨é‡Šè¯´æ˜æ¶æ„è®¾è®¡

---

### 3. æ—§ä¾èµ–æœªæ¸…ç† âš ï¸ ä½ä¼˜å…ˆçº§

**é—®é¢˜æè¿°**ï¼š[`package.json`](package.json:47-48) ä¸­ä»ä¿ç•™ IndexedDB ç›¸å…³ä¾èµ–ï¼š
```json
"dexie": "^4.2.1",
"dexie-react-hooks": "^4.2.0",
```

**å½±å“**ï¼š
- å¢åŠ  bundle ä½“ç§¯ï¼ˆçº¦ 200KBï¼‰
- å¼€å‘è€…å›°æƒ‘ï¼ˆå·²è¿ç§»åˆ° SQLite ä½†ä»æœ‰ Dexie ä¾èµ–ï¼‰

**å»ºè®®**ï¼šç§»é™¤æœªä½¿ç”¨çš„ä¾èµ–ï¼š
```bash
pnpm remove dexie dexie-react-hooks
```

---

### 4. å…¼å®¹å±‚ä»£ç å†—ä½™ âš ï¸ ä¸­ä¼˜å…ˆçº§

**é—®é¢˜æè¿°**ï¼š[`src/lib/db.ts`](src/lib/db.ts:626-818) ä¸­æœ‰çº¦ 200 è¡Œä»£ç ç”¨äºå…¼å®¹æ—§ Dexie APIï¼Œå¢åŠ äº†ç»´æŠ¤æˆæœ¬ã€‚

**ç¤ºä¾‹**ï¼ˆç¬¬ 632-720 è¡Œï¼‰ï¼š
```typescript
export const db = {
  notes: {
    orderBy: (field: string) => ({
      reverse: () => ({
        filter: (fn: (note: Note) => boolean) => ({
          toArray: async (): Promise<Note[]> => {
            // æ¨¡æ‹Ÿ Dexie é“¾å¼è°ƒç”¨ API
          }
        })
      })
    }),
    // ... å¤§é‡é“¾å¼è°ƒç”¨æ¨¡æ‹Ÿ
  }
}
```

**å»ºè®®**ï¼š
1. è¿ç§»å®Œæˆåï¼Œé‡æ„è°ƒç”¨æ–¹ä½¿ç”¨æ–°çš„ `noteOperations` API
2. åˆ é™¤å…¼å®¹å±‚ä»£ç ï¼Œç®€åŒ– db.ts

---

### 5. æ•°æ®åˆ·æ–°æœºåˆ¶ä¸ä¼˜é›… âš ï¸ ä¸­ä¼˜å…ˆçº§

**é—®é¢˜æè¿°**ï¼š[`src/hooks/useNotes.ts`](src/hooks/useNotes.ts:8) ä½¿ç”¨ `refreshKey` è®¡æ•°å™¨è§¦å‘åˆ·æ–°ï¼š
```typescript
const [refreshKey, setRefreshKey] = useState(0)

const createNote = useCallback(async () => {
  const id = await noteOperations.create()
  setRefreshKey((k) => k + 1)  // â† æ‰‹åŠ¨è§¦å‘åˆ·æ–°
  return id
}, [])
```

**é—®é¢˜**ï¼š
- æ²¡æœ‰å®æ—¶æ•°æ®è®¢é˜…
- æ¯æ¬¡æ“ä½œéƒ½å…¨é‡åˆ·æ–°
- å¯èƒ½å¯¼è‡´ä¸å¿…è¦çš„é‡æ¸²æŸ“

**å»ºè®®æ”¹è¿›**ï¼š
```typescript
// ä½¿ç”¨ useSyncExternalStore æˆ–è‡ªå®šä¹‰äº‹ä»¶ç³»ç»Ÿ
const notesStore = {
  listeners: new Set<() => void>(),
  subscribe(callback: () => void) {
    this.listeners.add(callback)
    return () => this.listeners.delete(callback)
  },
  notify() {
    this.listeners.forEach(fn => fn())
  }
}

// åœ¨æ“ä½œåè°ƒç”¨ notesStore.notify()
```

---

### 6. æ€§èƒ½ä¼˜åŒ–ç©ºé—´ âš ï¸ ä¸­ä¼˜å…ˆçº§

**é—®é¢˜æè¿°**ï¼š[`src/hooks/useNotes.ts`](src/hooks/useNotes.ts:11-18) æ¯æ¬¡éƒ½è·å–æ‰€æœ‰ç¬”è®°ååœ¨å†…å­˜è¿‡æ»¤ï¼š
```typescript
const refreshNotes = useCallback(async () => {
  const notes = await db.notes.orderBy('updatedAt').reverse().toArray()
  setAllNotes(notes)  // â† è·å–å…¨éƒ¨ç¬”è®°
}, [])
```

**å½±å“**ï¼š
- ç¬”è®°æ•°é‡å¤§æ—¶ï¼Œé¦–å±åŠ è½½æ…¢
- å†…å­˜å ç”¨é«˜

**å»ºè®®**ï¼š
1. å®ç°åˆ†é¡µåŠ è½½
2. å°†ç­›é€‰é€»è¾‘ç§»åˆ° SQL å±‚
3. æ·»åŠ è™šæ‹Ÿæ»šåŠ¨ï¼ˆä½¿ç”¨ `react-window` æˆ– `@tanstack/virtual`ï¼‰

**SQL å±‚ä¼˜åŒ–ç¤ºä¾‹**ï¼š
```typescript
async function getFilteredNotes(view: string, page: number, limit: number = 50) {
  const db = await getDatabase()
  let whereClause = 'is_deleted = 0'
  
  if (view === 'favorites') {
    whereClause += ' AND is_favorite = 1'
  } else if (view.startsWith('tag-')) {
    const tag = view.slice(4)
    whereClause += ` AND tags LIKE '%"${tag}"%'`
  }
  
  const offset = page * limit
  const rows = await db.select<NoteRow[]>(
    `SELECT * FROM notes WHERE ${whereClause} 
     ORDER BY updated_at DESC 
     LIMIT ? OFFSET ?`,
    [limit, offset]
  )
  return rows.map(rowToNote)
}
```

---

### 7. é”™è¯¯å¤„ç†ä¸å®Œå–„ âš ï¸ é«˜ä¼˜å…ˆçº§

**é—®é¢˜æè¿°**ï¼šå¤šå¤„ä»…ä½¿ç”¨ `console.error`ï¼Œç”¨æˆ·æ— æ³•æ„ŸçŸ¥é”™è¯¯ã€‚

**ç¤ºä¾‹**ï¼š[`src/hooks/useNotes.ts`](src/hooks/useNotes.ts:15-16)
```typescript
} catch (e) {
  console.error('Failed to load notes:', e)  // â† ç”¨æˆ·ä¸çŸ¥é“å‘ç”Ÿäº†é”™è¯¯
}
```

**å»ºè®®**ï¼šå®ç°å…¨å±€é”™è¯¯å¤„ç†å’Œ Toast é€šçŸ¥ï¼š
```typescript
// src/lib/toast.ts
export const toast = {
  error: (message: string) => {
    // æ˜¾ç¤ºé”™è¯¯æç¤º
  },
  success: (message: string) => {
    // æ˜¾ç¤ºæˆåŠŸæç¤º
  }
}

// ä½¿ç”¨
} catch (e) {
  console.error('Failed to load notes:', e)
  toast.error('åŠ è½½ç¬”è®°å¤±è´¥ï¼Œè¯·ç¨€é‡Šé‡è¯•')
}
```

---

### 8. è‡ªåŠ¨ä¿å­˜é€»è¾‘å¤æ‚ âš ï¸ ä¸­ä¼˜å…ˆçº§

**é—®é¢˜æè¿°**ï¼š[`src/hooks/useAutoSave.ts`](src/hooks/useAutoSave.ts:1-305) ä½¿ç”¨äº† 7 ä¸ª `useRef` æ¥ç®¡ç†çŠ¶æ€ï¼š
```typescript
const timeoutRef = useRef<...>(null)
const lastSavedRef = useRef({ title: '', content: '' })
const isFirstRender = useRef(true)
const isSavingRef = useRef(false)
const currentDataRef = useRef({ noteId, title, content })
const prevNoteIdRef = useRef<number | null>(null)
const prevDataRef = useRef<...>(null)
```

**é—®é¢˜**ï¼š
- ä»£ç å¤æ‚åº¦é«˜ï¼Œéš¾ä»¥ç»´æŠ¤
- å¯èƒ½å­˜åœ¨è¾¹ç•Œæƒ…å†µçš„ bug
- åˆ‡æ¢ç¬”è®°æ—¶çš„ä¿å­˜é€»è¾‘å®¹æ˜“å‡ºé”™

**å»ºè®®**ï¼šä½¿ç”¨çŠ¶æ€æœºæˆ– reducer æ¨¡å¼é‡æ„ï¼š
```typescript
type SaveState = 
  | { status: 'idle' }
  | { status: 'pending'; noteId: number; data: { title: string; content: string } }
  | { status: 'saving'; noteId: number }

function saveReducer(state: SaveState, action: SaveAction): SaveState {
  // çŠ¶æ€è½¬æ¢é€»è¾‘
}
```

---

### 9. AI æµå¼å“åº”ç¼ºå°‘é‡è¯•æœºåˆ¶ âš ï¸ ä½ä¼˜å…ˆçº§

**é—®é¢˜æè¿°**ï¼š[`src/hooks/useAIStream.ts`](src/hooks/useAIStream.ts:138-154) æ²¡æœ‰ç½‘ç»œé”™è¯¯é‡è¯•ï¼š
```typescript
const response = await fetch(`${settings.aiBaseUrl}/v1/chat/completions`, {
  // ...
})
// å¦‚æœç½‘ç»œé—ªæ–­ï¼Œç›´æ¥å¤±è´¥
```

**å»ºè®®**ï¼šæ·»åŠ æŒ‡æ•°é€€é¿é‡è¯•ï¼š
```typescript
async function fetchWithRetry(url: string, options: RequestInit, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      const response = await fetch(url, options)
      if (response.ok) return response
    } catch (e) {
      if (i === maxRetries - 1) throw e
      await sleep(Math.pow(2, i) * 1000) // 1s, 2s, 4s
    }
  }
}
```

---

## ğŸŸ¡ åŠŸèƒ½å±‚é¢çš„ç¼ºå¤±

åŸºäº [`plans/åŠŸèƒ½ä¼˜åŒ–å»ºè®®æ–¹æ¡ˆ.md`](plans/åŠŸèƒ½ä¼˜åŒ–å»ºè®®æ–¹æ¡ˆ.md) çš„åˆ†æï¼š

### é«˜ä¼˜å…ˆçº§åŠŸèƒ½

| åŠŸèƒ½ | æè¿° | å®ç°éš¾åº¦ | ç”¨æˆ·ä»·å€¼ |
|------|------|----------|----------|
| **ä»»åŠ¡åˆ—è¡¨** | æ”¯æŒ `- [ ]` å¤é€‰æ¡†è¯­æ³• | ä½ | â­â­â­ |
| **ç¬”è®°æ¨¡æ¿** | é¢„è®¾æ¨¡æ¿ + è‡ªå®šä¹‰æ¨¡æ¿ | ä¸­ | â­â­â­ |
| **æ’åºç­›é€‰** | æŒ‰æ—¶é—´/æ ‡é¢˜/æ”¶è—æ’åº | ä½ | â­â­ |

### ä¸­ä¼˜å…ˆçº§åŠŸèƒ½

| åŠŸèƒ½ | æè¿° | å®ç°éš¾åº¦ | ç”¨æˆ·ä»·å€¼ |
|------|------|----------|----------|
| **è¡¨æ ¼æ”¯æŒ** | å¯è§†åŒ–è¡¨æ ¼ç¼–è¾‘ | ä½ | â­â­ |
| **åŒå‘é“¾æ¥** | `[[ç¬”è®°æ ‡é¢˜]]` è¯­æ³• | ä¸­ | â­â­â­ |
| **Mermaid å›¾è¡¨** | æµç¨‹å›¾ã€æ—¶åºå›¾ | ä½ | â­â­ |
| **ç‰ˆæœ¬å†å²** | ç¬”è®°ä¿®æ”¹å†å² | é«˜ | â­â­ |

---

## ğŸŸ¢ UI/UX ä¼˜åŒ–å»ºè®®

### 1. ç¬”è®°åˆ—è¡¨ç»„ä»¶ [`NoteList.tsx`](src/components/layout/NoteList.tsx)

**å½“å‰é—®é¢˜**ï¼š
- å›ºå®šå®½åº¦ 320pxï¼Œä¸å“åº”çª—å£å¤§å°
- æ²¡æœ‰è™šæ‹Ÿæ»šåŠ¨ï¼Œå¤§é‡ç¬”è®°æ—¶å¡é¡¿
- ç¼ºå°‘æ‹–æ‹½æ’åºåŠŸèƒ½ï¼ˆè™½ç„¶å·²æœ‰ `@dnd-kit` ä¾èµ–ï¼‰

**å»ºè®®æ”¹è¿›**ï¼š
```tsx
// ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨
import { useVirtualizer } from '@tanstack/react-virtual'

const rowVirtualizer = useVirtualizer({
  count: notes.length,
  getScrollElement: () => parentRef.current,
  estimateSize: () => 80,
})
```

### 2. ç¼–è¾‘å™¨ [`Editor.tsx`](src/components/editor/Editor.tsx)

**å½“å‰é—®é¢˜**ï¼š
- æ²¡æœ‰å­—æ•°ç»Ÿè®¡
- æ²¡æœ‰é˜…è¯»æ—¶é—´ä¼°ç®—
- æ²¡æœ‰å¤§çº²å¯¼èˆª

**å»ºè®®æ·»åŠ **ï¼š
```tsx
// å­—æ•°ç»Ÿè®¡ç»„ä»¶
function WordCount({ content }: { content: string }) {
  const words = content.trim().split(/\s+/).length
  const chars = content.length
  const readingTime = Math.ceil(words / 200) // 200 å­—/åˆ†é’Ÿ
  
  return (
    <div className="text-xs text-gray-400">
      {chars} å­—ç¬¦ Â· {words} è¯ Â· çº¦ {readingTime} åˆ†é’Ÿé˜…è¯»
    </div>
  )
}
```

### 3. è®¾ç½®é¡µé¢ [`SettingsModal.tsx`](src/components/modals/SettingsModal.tsx)

**å½“å‰é—®é¢˜**ï¼š
- æ‰€æœ‰è®¾ç½®æŒ¤åœ¨ä¸€ä¸ªå¼¹çª—ä¸­
- ç¼ºå°‘å¿«æ·é”®è®¾ç½®
- ç¼ºå°‘å¤–è§‚å®šåˆ¶ï¼ˆå­—ä½“å¤§å°ã€è¡Œé«˜ç­‰ï¼‰

**å»ºè®®æ”¹è¿›**ï¼š
- ä½¿ç”¨åˆ†é¡µå¼è®¾ç½®ï¼ˆAI / æ•°æ® / å¤–è§‚ / å¿«æ·é”®ï¼‰
- æ·»åŠ è‡ªå®šä¹‰ä¸»é¢˜è‰²

---

## ğŸ“ ä»£ç è´¨é‡æ”¹è¿›

### 1. æ·»åŠ ç¼ºå¤±çš„ç±»å‹å£°æ˜

åˆ›å»º `src/types/index.d.ts`ï¼š
```typescript
// TipTap æ‰©å±•ç±»å‹
declare module '@tiptap/core' {
  interface EditorStorage {
    markdown: {
      getMarkdown: () => string
    }
  }
}

// å…¨å±€å·¥å…·ç±»å‹
type DeepPartial<T> = {
  [P in keyof T]?: T[P] extends object ? DeepPartial<T[P]> : T[P]
}
```

### 2. ç»Ÿä¸€ API é”™è¯¯å¤„ç†

åˆ›å»º `src/lib/api.ts`ï¼š
```typescript
export class ApiError extends Error {
  constructor(
    message: string,
    public code: string,
    public status?: number
  ) {
    super(message)
    this.name = 'ApiError'
  }
}

export async function handleApiResponse<T>(response: Response): Promise<T> {
  if (!response.ok) {
    throw new ApiError(
      `è¯·æ±‚å¤±è´¥: ${response.statusText}`,
      'API_ERROR',
      response.status
    )
  }
  return response.json()
}
```

### 3. æ·»åŠ å•å…ƒæµ‹è¯•

å½“å‰é¡¹ç›®æ²¡æœ‰æµ‹è¯•æ–‡ä»¶ï¼Œå»ºè®®æ·»åŠ ï¼š
```bash
pnpm add -D vitest @testing-library/react @testing-library/jest-dom
```

æµ‹è¯•ç¤ºä¾‹ï¼š
```typescript
// src/lib/db.test.ts
import { describe, it, expect } from 'vitest'
import { formatDateKey } from './db'

describe('formatDateKey', () => {
  it('should format date correctly', () => {
    const date = new Date('2026-01-06T12:00:00')
    expect(formatDateKey(date)).toBe('2026-01-06')
  })
})
```

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. React ç»„ä»¶ä¼˜åŒ–

```tsx
// ä½¿ç”¨ memo é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
import { memo, useMemo } from 'react'

const NoteCard = memo(function NoteCard({ note, active, onClick }: NoteCardProps) {
  // ...
})

// ä½¿ç”¨ useMemo ç¼“å­˜è®¡ç®—ç»“æœ
const filteredNotes = useMemo(() => {
  return notes.filter(note => /* ... */)
}, [notes, filter])
```

### 2. å›¾ç‰‡ä¼˜åŒ–

å½“å‰å›¾ç‰‡ç›´æ¥å­˜å‚¨ä¸º Base64ï¼Œå¤§å›¾ç‰‡ä¼šå½±å“æ€§èƒ½ï¼š
```typescript
// æ·»åŠ å›¾ç‰‡å‹ç¼©
import imageCompression from 'browser-image-compression'

async function handleImageUpload(file: File) {
  const compressed = await imageCompression(file, {
    maxSizeMB: 1,
    maxWidthOrHeight: 1920,
  })
  // ...
}
```

### 3. æ‡’åŠ è½½ AI ç»„ä»¶

AI ç›¸å…³ç»„ä»¶å¯ä»¥æ‡’åŠ è½½ï¼š
```tsx
const AIChatSidebar = lazy(() => import('./ai/AIChatSidebar'))
const AIContextMenu = lazy(() => import('./ai/AIContextMenu'))
```

---

## ğŸ“Š ä¼˜åŒ–ä¼˜å…ˆçº§çŸ©é˜µ

```
                é«˜ä»·å€¼
                  â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ ä»»åŠ¡åˆ—è¡¨ â”‚ é”™è¯¯å¤„ç† â”‚
      â”‚ ç¬”è®°æ¨¡æ¿ â”‚ ç±»å‹å®‰å…¨ â”‚
  ä½  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ é«˜
 éš¾åº¦ â”‚ æ’åºç­›é€‰ â”‚ æ€§èƒ½ä¼˜åŒ– â”‚ éš¾åº¦
      â”‚ è¡¨æ ¼æ”¯æŒ â”‚ è‡ªåŠ¨ä¿å­˜ â”‚
      â”‚ æ¸…ç†ä¾èµ– â”‚ åŒå‘é“¾æ¥ â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                ä½ä»·å€¼
```

---

## âœ… å»ºè®®å®æ–½è·¯çº¿

### ç¬¬ä¸€é˜¶æ®µï¼ˆ1-2 å¤©ï¼‰- ä»£ç æ¸…ç†
- [ ] ç§»é™¤æœªä½¿ç”¨çš„ Dexie ä¾èµ–
- [ ] ä¿®å¤ç±»å‹å®‰å…¨é—®é¢˜
- [ ] æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†
- [ ] æ¸…ç†åç«¯å ä½å‘½ä»¤

### ç¬¬äºŒé˜¶æ®µï¼ˆ2-3 å¤©ï¼‰- æ€§èƒ½ä¼˜åŒ–
- [ ] å®ç°ç¬”è®°åˆ—è¡¨åˆ†é¡µåŠ è½½
- [ ] æ·»åŠ è™šæ‹Ÿæ»šåŠ¨
- [ ] é‡æ„è‡ªåŠ¨ä¿å­˜é€»è¾‘
- [ ] ä¼˜åŒ–æ•°æ®åˆ·æ–°æœºåˆ¶

### ç¬¬ä¸‰é˜¶æ®µï¼ˆ3-5 å¤©ï¼‰- åŠŸèƒ½å¢å¼º
- [ ] å®ç°ä»»åŠ¡åˆ—è¡¨åŠŸèƒ½
- [ ] æ·»åŠ ç¬”è®°æ¨¡æ¿ç³»ç»Ÿ
- [ ] å¢å¼ºæ’åºç­›é€‰
- [ ] æ·»åŠ è¡¨æ ¼æ”¯æŒ

### ç¬¬å››é˜¶æ®µï¼ˆå¯é€‰ï¼‰- é«˜çº§åŠŸèƒ½
- [ ] åŒå‘é“¾æ¥
- [ ] ç‰ˆæœ¬å†å²
- [ ] Mermaid å›¾è¡¨
- [ ] æœç´¢å¢å¼º

---

## ğŸ“š æ€»ç»“

JD Notes å·²ç»æ˜¯ä¸€ä¸ªåŠŸèƒ½ç›¸å¯¹å®Œå–„çš„ç¬”è®°åº”ç”¨ï¼Œä¸»è¦é—®é¢˜é›†ä¸­åœ¨ï¼š

1. **ä»£ç è´¨é‡**ï¼šç±»å‹å®‰å…¨ã€å†—ä½™ä»£ç ã€å¤æ‚é€»è¾‘
2. **æ€§èƒ½**ï¼šå…¨é‡åŠ è½½ã€æ— è™šæ‹Ÿæ»šåŠ¨
3. **åŠŸèƒ½å®Œæ•´æ€§**ï¼šç¼ºå°‘ä»»åŠ¡åˆ—è¡¨ã€æ¨¡æ¿ç­‰å¸¸ç”¨åŠŸèƒ½

å»ºè®®ä¼˜å…ˆå¤„ç†ç¬¬ä¸€é˜¶æ®µçš„ä»£ç æ¸…ç†å·¥ä½œï¼Œè¿™äº›æ”¹åŠ¨é£é™©ä½ã€æ”¶ç›Šé«˜ï¼Œèƒ½å¤Ÿæ˜¾è‘—æå‡ä»£ç å¯ç»´æŠ¤æ€§ã€‚
