# JD Notes 软件更新发布指南

本指南详细说明如何发布新版本，让用户能够通过应用内的"检查更新"功能自动更新。

## 一、首次配置（只需执行一次）

### 1. 生成签名密钥

Tauri 更新需要对安装包进行签名以确保安全性。

```bash
# 方式1: 使用 npm 脚本
pnpm signer:generate

# 方式2: 直接执行命令
pnpm tauri signer generate -w ~/.tauri/jdnotes.key
```

执行后会输出：
- **私钥文件**: `~/.tauri/jdnotes.key`（请妥善保管，不要泄露！）
- **公钥字符串**: 类似 `dW50cnVzdGVkIGNvbW1lbnQ...` 的长字符串

### 2. 配置公钥

将生成的公钥填入 `src-tauri/tauri.conf.json`：

```json
"plugins": {
  "updater": {
    "endpoints": [
      "https://github.com/你的用户名/jdnotes/releases/latest/download/latest.json"
    ],
    "pubkey": "dW50cnVzdGVkIGNvbW1lbnQ...（你的公钥）"
  }
}
```

### 3. 设置 GitHub Secrets（CI/CD 方式）

如果使用 GitHub Actions 自动发布，需要添加 Secrets：
1. 进入 GitHub 仓库 → Settings → Secrets and variables → Actions
2. 添加 `TAURI_SIGNING_PRIVATE_KEY`：私钥内容
3. 添加 `TAURI_SIGNING_PRIVATE_KEY_PASSWORD`：私钥密码（如果设置了）

---

## 二、发布新版本步骤

### 方式一：使用打包脚本（推荐）

项目提供了自动化打包脚本，位于 `scripts/` 目录。

#### PowerShell 脚本（推荐）

```bash
# 方式1: 通过 npm 脚本运行
pnpm release

# 方式2: 直接运行脚本
.\scripts\build-release.ps1

# 方式3: 指定版本号
.\scripts\build-release.ps1 -Version "0.2.0"

# 方式4: 跳过构建（仅整理已构建的文件）
.\scripts\build-release.ps1 -SkipBuild
```

#### 批处理脚本

```bash
# 方式1: 通过 npm 脚本运行
pnpm release:bat

# 方式2: 直接运行
.\scripts\build-release.bat
```

#### 脚本功能

打包脚本会自动执行以下操作：

1. **版本号管理**
   - 显示当前版本号
   - 交互式输入新版本号
   - 自动更新 `tauri.conf.json`、`package.json`、`Cargo.toml`

2. **签名密钥检查**
   - 自动检测 `~/.tauri/jdnotes.key`
   - 未找到时提示生成新密钥

3. **构建应用**
   - 自动执行 `pnpm install`
   - 执行 `pnpm tauri build`

4. **整理输出**
   - 创建 `release/vX.X.X/` 目录
   - 复制安装包、更新包、签名文件
   - 自动生成 `latest.json`

5. **输出结果**
   ```
   release/v0.2.0/
   ├── jdnotes_0.2.0_x64-setup.exe       # Windows 安装包
   ├── jdnotes_0.2.0_x64-setup.nsis.zip  # Windows 更新包
   ├── jdnotes_0.2.0_x64-setup.nsis.zip.sig  # 签名文件
   └── latest.json                        # 更新元数据
   ```

#### 发布到 GitHub

1. 编辑 `release/vX.X.X/latest.json`，修改更新说明
2. 修改 `latest.json` 中的下载 URL 为实际地址
3. 进入 GitHub 仓库 → Releases → Create a new release
4. 创建标签（如 `v0.2.0`），上传所有文件
5. 点击 Publish release

---

### 方式二：手动发布

#### 步骤 1：更新版本号

修改 `src-tauri/tauri.conf.json` 中的版本号：

```json
{
  "version": "0.2.0"  // 从 0.1.0 改为 0.2.0
}
```

也可以同步更新 `package.json`：

```json
{
  "version": "0.2.0"
}
```

#### 步骤 2：构建发布包

```bash
# 设置签名私钥环境变量
# Windows PowerShell:
$env:TAURI_SIGNING_PRIVATE_KEY = Get-Content ~/.tauri/jdnotes.key -Raw

# Windows CMD:
set TAURI_SIGNING_PRIVATE_KEY_FILE=C:\Users\你的用户名\.tauri\jdnotes.key

# macOS/Linux:
export TAURI_SIGNING_PRIVATE_KEY=$(cat ~/.tauri/jdnotes.key)

# 构建
pnpm tauri build
```

构建完成后，在 `src-tauri/target/release/bundle/` 目录下会生成：
- Windows: `jdnotes_0.2.0_x64-setup.exe` 和 `jdnotes_0.2.0_x64-setup.nsis.zip`
- macOS: `jdnotes_0.2.0_aarch64.dmg` 或 `jdnotes_0.2.0_x64.dmg`
- Linux: `jdnotes_0.2.0_amd64.deb` 或 `.AppImage`

还会生成对应的 `.sig` 签名文件。

#### 步骤 3：创建 latest.json

创建更新元数据文件 `latest.json`：

```json
{
  "version": "0.2.0",
  "notes": "## 更新内容\n\n- 新增软件更新功能\n- 修复若干 Bug",
  "pub_date": "2026-01-06T08:00:00Z",
  "platforms": {
    "windows-x86_64": {
      "signature": "（复制 .nsis.zip.sig 文件内容）",
      "url": "https://github.com/你的用户名/jdnotes/releases/download/v0.2.0/jdnotes_0.2.0_x64-setup.nsis.zip"
    },
    "darwin-x86_64": {
      "signature": "（复制 .dmg.sig 或 .app.tar.gz.sig 文件内容）",
      "url": "https://github.com/你的用户名/jdnotes/releases/download/v0.2.0/jdnotes_0.2.0_x64.app.tar.gz"
    },
    "darwin-aarch64": {
      "signature": "（签名内容）",
      "url": "https://github.com/你的用户名/jdnotes/releases/download/v0.2.0/jdnotes_0.2.0_aarch64.app.tar.gz"
    },
    "linux-x86_64": {
      "signature": "（签名内容）",
      "url": "https://github.com/你的用户名/jdnotes/releases/download/v0.2.0/jdnotes_0.2.0_amd64.AppImage.tar.gz"
    }
  }
}
```

> ⚠️ 签名内容在构建生成的 `.sig` 文件中，直接复制文件内容即可。

#### 步骤 4：发布到 GitHub Releases

1. 进入 GitHub 仓库 → Releases → Create a new release
2. 创建新标签，如 `v0.2.0`
3. 填写发布标题和说明
4. 上传文件：
   - `jdnotes_0.2.0_x64-setup.exe`（Windows 安装包）
   - `jdnotes_0.2.0_x64-setup.nsis.zip`（Windows 更新包）
   - `latest.json`（更新元数据）
   - 其他平台的安装包
5. 点击 Publish release

---

### 方式三：GitHub Actions 自动发布

创建 `.github/workflows/release.yml`：

```yaml
name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
          - platform: 'ubuntu-22.04'
            args: ''
          - platform: 'windows-latest'
            args: ''

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install frontend dependencies
        run: pnpm install

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: v__VERSION__
          releaseName: 'JD Notes v__VERSION__'
          releaseBody: '查看完整更新日志请点击 [CHANGELOG](https://github.com/你的用户名/jdnotes/blob/main/CHANGELOG.md)'
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.args }}
```

使用方法：
1. 提交代码并推送
2. 创建并推送 tag：
   ```bash
   git tag v0.2.0
   git push origin v0.2.0
   ```
3. GitHub Actions 自动构建并创建 Draft Release
4. 检查 Draft Release，确认无误后点击 Publish

---

## 三、npm 脚本命令一览

| 命令 | 说明 |
|------|------|
| `pnpm release` | 运行 PowerShell 打包脚本 |
| `pnpm release:bat` | 运行批处理打包脚本 |
| `pnpm signer:generate` | 生成签名密钥 |
| `pnpm tauri:dev` | 开发模式运行 |
| `pnpm tauri:build` | 仅构建（不整理输出） |

---

## 四、更新配置选项

### 更新检查源

在 `tauri.conf.json` 中可以配置多个更新源：

```json
"plugins": {
  "updater": {
    "endpoints": [
      "https://github.com/你的用户名/jdnotes/releases/latest/download/latest.json",
      "https://你的备用服务器/updates/latest.json"
    ],
    "pubkey": "你的公钥"
  }
}
```

### 自建更新服务器

如果不想用 GitHub，可以自建服务器托管 `latest.json` 和安装包，只需确保：
1. `latest.json` 的 URL 与 `endpoints` 配置一致
2. 安装包 URL 可访问
3. 签名文件正确

---

## 五、用户体验流程

1. 用户打开应用 → 设置 → 软件更新 → 点击"检查更新"
2. 发现新版本 → 显示版本号和更新说明
3. 点击"下载并安装" → 显示下载进度
4. 下载完成 → 自动安装并重启应用

---

## 六、常见问题

### Q: 更新检查失败？
- 检查网络连接
- 确认 `endpoints` URL 可访问
- 检查 `latest.json` 格式是否正确

### Q: 签名验证失败？
- 确认 `pubkey` 配置正确
- 确认构建时使用了正确的私钥
- 检查 `.sig` 文件内容是否完整复制到 `latest.json`

### Q: Windows 安装时杀毒软件报警？
- 这是因为程序未签名，建议购买 Windows 代码签名证书
- 可以暂时要求用户添加信任

### Q: 打包脚本执行出错？
- 确保在项目根目录运行
- PowerShell 需要设置执行策略：`Set-ExecutionPolicy -Scope CurrentUser RemoteSigned`
- 检查 pnpm 是否已安装

---

## 七、版本号规范

建议使用语义化版本 (SemVer)：

- `主版本.次版本.修订版本`
- 例如：`0.1.0` → `0.2.0` → `1.0.0`

修改规则：
- 修订版本：Bug 修复
- 次版本：新功能（向后兼容）
- 主版本：重大更改（可能不兼容）

---

## 八、快速发布检查清单

- [ ] 确认代码已提交
- [ ] 运行 `pnpm release` 打包
- [ ] 检查 `release/vX.X.X/` 目录文件
- [ ] 编辑 `latest.json` 更新说明
- [ ] 修改 `latest.json` 中的下载 URL
- [ ] 上传到 GitHub Releases
- [ ] 发布 Release
- [ ] 测试更新功能
