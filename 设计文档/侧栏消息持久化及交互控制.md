# Role
Expert React & Dexie.js Architect (Linear/Cursor Style specialist).

# Context
Our Note App (JD Notes) has an AI Chat Sidebar. We need to upgrade it with Persistence and Professional UX.

# Core Logic to Implement (Mandatory)

## 1. Data Persistence (Dexie.js)
- **Table Structure**: Create/Update `chatMessages` table in `db.ts`. 
  - Fields: `id++`, `noteId` (indexed), `role` ('user'|'assistant'), `content`, `timestamp`.
- **Note Isolation**: When `activeNoteId` changes, the chat list must immediately refresh to show messages linked ONLY to that `noteId`.

## 2. Advanced Message Interactions
- **Edit & Resend (Cursor Logic)**: 
  - If a user edits a past message, the app must:
    1. Delete the old message and **all subsequent messages** in this specific note's history (truncating the thread).
    2. Add the new edited message to DB.
    3. Trigger a new AI request based on the new state.
- **Copy & Delete**: 
  - Add a hover-action bar for each message.
  - "Copy" uses `navigator.clipboard`.
  - "Delete" removes the specific message from DB.
- **Retry**: Re-run the generation for the last assistant message.

## 3. Streaming Optimization (Performance)
- **State vs DB**: During AI streaming, store the incoming chunks in a **React Local State** only. 
- **Persist on Finish**: ONLY perform the `db.chatMessages.add()` operation once the stream is 100% complete (`onFinish`). This prevents unnecessary database writes/thrashing during high-frequency streaming.

## 4. UI/UX (Linear Aesthetic)
- **Markdown Rendering**: Use `react-markdown` with `remark-gfm`. AI code blocks must be styled with a dark background and `font-mono`.
- **Message Item (`ChatMessageItem`)**:
  - Hover Action Bar: Small icons (`Copy`, `Pencil`, `RotateCcw`, `Trash`) appearing on hover.
  - Style: No bubbles. Use a clean, horizontal divider or subtle spacing. Use `text-indigo-600` for the user and standard text for AI.
- **Auto-Scroll**: Implement a "Scroll to bottom" hook that triggers when the message list or the active stream content changes.

# Requirements
1. Updated `db.ts` schema.
2. The complete `AIChatSidebar.tsx` and `ChatMessageItem.tsx`.
3. The integrated `useAIStream` logic within the sidebar.

# Error Handling
- Handle "empty history" state with a clean placeholder.
- If AI request fails, show an error message and allow "Retry".